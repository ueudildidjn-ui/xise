# 水印处理迁移说明

## 概述

本项目已将水印处理从 `sharp` 的 SVG 方法迁移到 `@napi-rs/canvas`，以提供更好的性能和更完整的功能支持。

## 变更详情

### 新增依赖
- **@napi-rs/canvas**: 用于生成文字水印和处理图片透明度

### 保留依赖
- **sharp**: 继续用于图片缩放、转换和合成

## 技术优势

### 1. 更好的中文字符支持
- 使用 Canvas API 原生渲染，中文字符显示更准确
- 支持各种字符集和特殊字符

### 2. 改进的字体处理
- 使用 `GlobalFonts.registerFromPath()` 注册自定义字体
- 自动生成唯一的字体名称，避免冲突
- 支持字体回退机制

### 3. 高性能像素处理
- 使用 `Uint8ClampedArray` 优化像素操作
- 批量处理透明度调整
- 减少内存分配

## 功能对比

| 功能 | 旧实现 (SVG) | 新实现 (Canvas) |
|------|-------------|----------------|
| 文字渲染 | SVG + librsvg | Canvas 原生 |
| 字体支持 | Base64嵌入 | 直接注册 |
| 透明度处理 | Sharp 手动处理 | Canvas ImageData |
| 中文支持 | 依赖系统字体 | 更好的渲染 |
| 性能 | 中等 | 更优 |

## API 保持不变

所有外部 API 保持兼容：
- `processImage()` - 主处理函数
- `applyTextWatermark()` - 文字水印
- `applyImageWatermark()` - 图片水印
- `applyUsernameWatermark()` - 用户名水印

## 配置兼容性

所有现有配置项完全兼容：
- 水印位置 (九宫格 1-9)
- 透明度 (0-100)
- 字体大小
- 颜色设置
- 平铺模式
- 自定义字体路径

## 测试覆盖

✅ 文字水印（基础和自定义透明度）
✅ 图片水印（单个和平铺模式）
✅ 用户名水印
✅ 中文字符支持
✅ 不同位置（九宫格 1-9）
✅ 性能测试（4000x3000px）
✅ 特殊字符和表情符号
✅ 多种透明度级别

## 迁移检查清单

- [x] 安装 @napi-rs/canvas 依赖
- [x] 重构水印生成函数
- [x] 更新字体处理逻辑
- [x] 优化像素处理
- [x] 全面测试所有功能
- [x] 代码审查
- [x] 安全扫描（无漏洞）
- [x] 性能验证

## 性能指标

基于测试结果：
- 800x600px 图片 + 双水印: ~50ms
- 4000x3000px 图片 + 双水印: ~830ms
- 内存使用: 稳定，无泄漏

## 向后兼容性

✅ 完全向后兼容
✅ 无需修改现有配置
✅ API 签名保持不变
✅ 所有功能正常工作

## 故障排除

### 字体问题
如果自定义字体未加载：
1. 检查字体文件路径
2. 确认字体格式（TTF/OTF）
3. 查看控制台日志

### 性能问题
如果处理速度慢：
1. 检查图片尺寸
2. 考虑启用图片缩放
3. 减少水印数量（平铺模式）

## 未来改进

可能的优化方向：
- 支持更多字体格式
- 添加水印模板系统
- 实现水印缓存机制
- 支持动态水印效果
