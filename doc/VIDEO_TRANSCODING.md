# 视频转码多码率优化说明

## 功能概述

本系统支持智能视频转码，可以自动识别任意分辨率的视频，并按比例转换为多个码率版本，用于DASH自适应流媒体播放。

## 核心特性

### 1. 智能分辨率检测
- 自动识别视频的实际分辨率和宽高比
- 支持横屏、竖屏和任意宽高比的视频
- 无需预先定义所有可能的分辨率

### 2. 等比例缩放
- 根据源视频的宽高比自动计算目标分辨率
- **保证视频不变形**，完美保持原始宽高比
- 支持常见和不常见的分辨率，如：
  - 标准16:9：1920x1080、1280x720
  - 宽屏16:10：1920x1200、1680x1050
  - 传统4:3：1440x1080、1024x768
  - 竖屏9:16：720x1280、1080x1920
  - Instagram 4:5：1080x1350

### 3. 短边匹配策略
- 使用视频的"短边"作为匹配标准
- 横屏视频(1920x1080)：短边是1080（高度）→ 匹配1080p
- 竖屏视频(720x1280)：短边是720（宽度）→ 匹配720p
- 这样可以统一处理不同方向的视频

### 4. 智能码率检测
- 只转码到源视频质量支持的分辨率
- 如果源视频码率低于目标码率的80%，则跳过该分辨率
- 避免低质量视频被强制转码到高码率

## 配置说明

### 环境变量格式

```bash
DASH_RESOLUTIONS=分辨率1:码率1,分辨率2:码率2,...
```

### 两种配置格式

#### 格式1：标准格式（宽x高:码率）
```bash
DASH_RESOLUTIONS=1920x1080:5000,1280x720:2500,854x480:1000,640x360:500
```

#### 格式2：简化格式（高度p:码率）
```bash
DASH_RESOLUTIONS=1080p:5000,720p:2500,480p:1000,360p:500
```

**注意**：简化格式会自动使用16:9宽高比计算宽度。

### 配置参数说明
- **分辨率**：目标分辨率（仅用作参考，实际输出会根据源视频宽高比调整）
- **码率**：目标码率（单位：kbps，即kb/s）

## 转码示例

### 示例1：横屏16:10视频 (1920x1200)
源视频：1920x1200，码率6000kbps

转码结果：
- 1080p → 1728x1080 @ 5000kbps（保持1.6宽高比）
- 720p → 1152x720 @ 2500kbps（保持1.6宽高比）
- 480p → 768x480 @ 1000kbps（保持1.6宽高比）
- 360p → 576x360 @ 500kbps（保持1.6宽高比）

### 示例2：竖屏9:16视频 (720x1280)
源视频：720x1280，码率3000kbps

转码结果：
- 720p → 720x1280 @ 2500kbps（保持0.5625宽高比）
- 480p → 480x853 @ 1000kbps（保持0.5625宽高比）
- 360p → 360x640 @ 500kbps（保持0.5625宽高比）

### 示例3：4:3视频 (1440x1080)
源视频：1440x1080，码率5000kbps

转码结果：
- 1080p → 1440x1080 @ 5000kbps（保持1.333宽高比）
- 720p → 960x720 @ 2500kbps（保持1.333宽高比）
- 480p → 640x480 @ 1000kbps（保持1.333宽高比）
- 360p → 480x360 @ 500kbps（保持1.333宽高比）

### 示例4：低质量视频码率检测
源视频：854x480，码率800kbps

转码结果：
- 480p → 跳过（源码率800 < 目标码率1000）
- 360p → 854x480 @ 500kbps（唯一满足条件的分辨率）

## 技术实现

### 1. 宽高比计算
```javascript
const sourceAspectRatio = sourceWidth / sourceHeight;
```

### 2. 方向判断
```javascript
const isPortrait = sourceHeight > sourceWidth;
const shortSide = isPortrait ? sourceWidth : sourceHeight;
```

### 3. 等比例缩放算法
```javascript
if (isPortrait) {
  // 竖屏：以宽度（短边）为基准
  outputWidth = targetShortSide;
  outputHeight = Math.round(outputWidth / sourceAspectRatio);
} else {
  // 横屏：以高度（短边）为基准
  outputHeight = targetShortSide;
  outputWidth = Math.round(outputHeight * sourceAspectRatio);
}

// 确保是偶数（H.264要求）
outputWidth = Math.round(outputWidth / 2) * 2;
outputHeight = Math.round(outputHeight / 2) * 2;
```

### 4. 质量检查
```javascript
// 分辨率检查：源视频短边必须 >= 目标短边
if (sourceShortSide < targetShortSide) {
  continue; // 跳过此分辨率
}

// 码率检查：源视频码率必须 >= 目标码率的80%
if (sourceBitrate < targetBitrate * 0.8) {
  continue; // 跳过此分辨率
}
```

## 优势总结

1. ✅ **无需预定义所有分辨率**：系统自动处理任意输入分辨率
2. ✅ **完美保持宽高比**：视频永不变形
3. ✅ **支持横竖屏**：自动识别视频方向
4. ✅ **智能码率优化**：避免低质量视频的无效转码
5. ✅ **DASH多码率支持**：提供平滑的自适应播放体验
6. ✅ **灵活配置**：通过环境变量轻松调整码率策略

## 注意事项

1. 转码会消耗CPU资源，建议根据服务器性能调整并发任务数
2. 码率设置应根据实际网络环境和用户需求调整
3. 系统会自动跳过不符合质量要求的分辨率转码
4. 所有输出分辨率都会调整为偶数（满足H.264编码要求）

## 动态码率（VBR）说明

### 什么是动态码率

本系统默认使用 **VBR（Variable Bitrate，可变比特率）** 模式进行视频转码，而非固定码率（CBR）。

- **VBR 特点**：码率可以在 0 到最大值之间动态变化
- **优势**：
  - 复杂场景（动作、细节多）：使用较高码率，保证画质
  - 简单场景（静止、纯色多）：使用较低码率，节省带宽和存储空间
  - 整体质量更优，文件大小更合理

### 码率控制参数

在 VBR 模式下，系统使用以下参数控制码率：

```bash
-b:v ${目标码率}k         # 平均目标码率
-maxrate ${最大码率}k      # 最大码率上限（目标码率的1.5倍）
-bufsize ${缓冲区大小}k    # 码率控制缓冲区（最大码率的2倍）
```

### 码率计算示例

以 720p (2500kbps) 为例：

- **目标码率**：2500 kbps（平均水平）
- **最大码率**：3750 kbps（1.5倍，动态峰值）
- **缓冲区大小**：7500 kbps（3倍，平滑控制）

这意味着：
- 简单场景：码率可能降至 500-1000 kbps
- 复杂场景：码率可能升至 3000-3750 kbps
- 平均水平：接近 2500 kbps
- **绝对上限**：不会超过 3750 kbps

### CRF 模式（可选）

如果在 `.env` 中设置了 `FFMPEG_CRF` 参数，系统会切换到 **恒定质量模式（CRF）**：

```bash
# 设置 CRF 值（18-28推荐，23为默认）
FFMPEG_CRF=23
```

CRF 模式特点：
- 保持恒定的视觉质量
- 码率完全动态，自动调整以维持设定质量
- 配置的目标码率仅作为最大上限参考
- 通常产生更高的视觉质量和更优的文件大小

### 动态码率的优势

1. **节省存储空间**：简单场景不浪费码率
2. **提升画质**：复杂场景获得足够码率
3. **优化带宽使用**：ABR播放时更智能地切换码率
4. **用户体验更佳**：画质波动更小，播放更流畅

### 监控和调试

转码时，系统会输出每个流的码率配置：

```
📊 流0 VBR模式: 目标=2500k, 最大=3750k, 缓冲=7500k
📊 流1 VBR模式: 目标=5000k, 最大=7500k, 缓冲=15000k
```

通过这些日志可以确认码率配置是否符合预期。
