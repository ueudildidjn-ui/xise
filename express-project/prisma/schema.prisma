// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 管理员表
model Admin {
  id         BigInt   @id @default(autoincrement())
  username   String   @unique @db.VarChar(50)
  password   String   @db.VarChar(255)
  created_at DateTime @default(now())

  @@index([username], name: "idx_admin_username")
  @@map("admin")
}

// 审核表
model Audit {
  id           BigInt   @id @default(autoincrement())
  user_id      BigInt
  type         Int      @db.TinyInt
  target_id    BigInt?
  content      String   @db.Text
  audit_result Json?
  risk_level   String?  @db.VarChar(20)
  categories   Json?
  reason       String?  @db.Text
  retry_count  Int      @default(0)
  created_at   DateTime @default(now())
  audit_time   DateTime?
  status       Int?     @default(0) @db.TinyInt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], name: "idx_user_id")
  @@index([type], name: "idx_type")
  @@index([status], name: "idx_status")
  @@index([created_at], name: "idx_created_at")
  @@index([target_id], name: "idx_target_id")
  @@map("audit")
}

// 分类表
model Category {
  id             Int      @id @default(autoincrement())
  name           String   @unique @db.VarChar(50)
  category_title String?  @unique @db.VarChar(50)
  created_at     DateTime @default(now())

  posts Post[]

  @@map("categories")
}

// 收藏表
model Collection {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  post_id    BigInt
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id], name: "uk_user_post")
  @@index([user_id], name: "idx_user_id")
  @@index([post_id], name: "idx_post_id")
  @@map("collections")
}

// 评论表
model Comment {
  id           BigInt   @id @default(autoincrement())
  post_id      BigInt
  user_id      BigInt
  parent_id    BigInt?
  content      String   @db.Text
  like_count   Int      @default(0)
  audit_status Int      @default(1) @db.TinyInt
  is_public    Boolean  @default(true)
  audit_result Json?
  created_at   DateTime @default(now())

  post     Post      @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")
  notifications Notification[]

  @@index([post_id], name: "idx_post_id")
  @@index([user_id], name: "idx_user_id")
  @@index([parent_id], name: "idx_parent_id")
  @@index([created_at], name: "idx_created_at")
  @@index([audit_status], name: "idx_audit_status")
  @@index([is_public], name: "idx_is_public")
  @@map("comments")
}

// 关注关系表
model Follow {
  id           BigInt   @id @default(autoincrement())
  follower_id  BigInt
  following_id BigInt
  created_at   DateTime @default(now())

  follower  User @relation("Followers", fields: [follower_id], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [following_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, following_id], name: "uk_follow")
  @@index([follower_id], name: "idx_follower_id")
  @@index([following_id], name: "idx_following_id")
  @@index([follower_id, following_id], name: "idx_follower_following")
  @@map("follows")
}

// 点赞表
model Like {
  id          BigInt   @id @default(autoincrement())
  user_id     BigInt
  target_type Int      @db.TinyInt
  target_id   BigInt
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, target_type, target_id], name: "uk_user_target")
  @@index([user_id], name: "idx_user_id")
  @@index([target_type, target_id], name: "idx_target")
  @@index([user_id, target_type, target_id], name: "idx_user_target_type")
  @@map("likes")
}

// 通知表
model Notification {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  sender_id  BigInt
  type       Int      @db.TinyInt
  title      String   @db.VarChar(200)
  target_id  BigInt?
  comment_id BigInt?
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())

  user    User     @relation("NotificationReceiver", fields: [user_id], references: [id], onDelete: Cascade)
  sender  User     @relation("NotificationSender", fields: [sender_id], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [comment_id], references: [id], onDelete: Cascade)

  @@index([user_id], name: "idx_user_id")
  @@index([sender_id], name: "idx_sender_id")
  @@index([type], name: "idx_type")
  @@index([is_read], name: "idx_is_read")
  @@index([user_id, is_read], name: "idx_user_read")
  @@index([created_at], name: "idx_created_at")
  @@index([comment_id], name: "idx_notifications_comment_id")
  @@map("notifications")
}

// 石榴点变动记录表
model PointsLog {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  amount        Decimal  @db.Decimal(10, 2)
  balance_after Decimal  @db.Decimal(10, 2)
  type          String   @db.VarChar(50)
  reason        String?  @db.VarChar(255)
  created_at    DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], name: "idx_user_id")
  @@index([type], name: "idx_type")
  @@index([created_at], name: "idx_created_at")
  @@map("points_log")
}

// 笔记附件表
model PostAttachment {
  id             BigInt   @id @default(autoincrement())
  post_id        BigInt
  attachment_url String   @db.VarChar(500)
  filename       String   @db.VarChar(255)
  filesize       BigInt   @default(0)
  created_at     DateTime @default(now())

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@index([post_id], name: "idx_post_id")
  @@map("post_attachments")
}

// 笔记图片表
model PostImage {
  id              BigInt  @id @default(autoincrement())
  post_id         BigInt
  image_url       String  @db.VarChar(500)
  is_free_preview Boolean @default(true)

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@index([post_id], name: "idx_post_id")
  @@index([is_free_preview], name: "idx_is_free_preview")
  @@map("post_images")
}

// 帖子付费设置表
model PostPaymentSetting {
  id                 BigInt   @id @default(autoincrement())
  post_id            BigInt   @unique
  enabled            Boolean  @default(false)
  payment_type       String   @default("single") @db.VarChar(20)
  price              Decimal  @default(0.00) @db.Decimal(10, 2)
  free_preview_count Int      @default(0)
  preview_duration   Int      @default(0)
  hide_all           Boolean  @default(false)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@index([post_id], name: "idx_post_id")
  @@map("post_payment_settings")
}

// 笔记标签关联表
model PostTag {
  id         BigInt   @id @default(autoincrement())
  post_id    BigInt
  tag_id     Int
  created_at DateTime @default(now())

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([post_id, tag_id], name: "uk_post_tag")
  @@index([post_id], name: "idx_post_id")
  @@index([tag_id], name: "idx_tag_id")
  @@map("post_tags")
}

// 笔记视频表
model PostVideo {
  id                BigInt              @id @default(autoincrement())
  post_id           BigInt
  cover_url         String?             @db.VarChar(500)
  video_url         String              @db.VarChar(500)
  dash_url          String?             @db.VarChar(500)
  preview_video_url String?             @db.VarChar(500)
  mpd_path          String?             @db.VarChar(500)
  transcode_status  TranscodeStatus?    @default(none)
  transcode_task_id String?             @db.VarChar(100)

  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@index([post_id], name: "idx_post_id")
  @@index([transcode_status], name: "idx_transcode_status")
  @@index([dash_url], name: "idx_dash_url")
  @@map("post_videos")
}

enum TranscodeStatus {
  pending
  processing
  completed
  failed
  none
}

// 笔记表
model Post {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  title         String   @db.VarChar(200)
  content       String   @db.Text
  category_id   Int?
  type          Int      @default(1)
  view_count    BigInt   @default(0)
  like_count    Int      @default(0)
  collect_count Int      @default(0)
  comment_count Int      @default(0)
  created_at    DateTime @default(now())
  is_draft      Boolean  @default(true)

  user            User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  category        Category?           @relation(fields: [category_id], references: [id], onDelete: SetNull)
  images          PostImage[]
  videos          PostVideo[]
  tags            PostTag[]
  comments        Comment[]
  collections     Collection[]
  attachments     PostAttachment[]
  paymentSettings PostPaymentSetting?
  purchasedBy     UserPurchasedContent[]

  @@index([user_id], name: "idx_user_id")
  @@index([category_id], name: "idx_category_id")
  @@index([created_at], name: "idx_created_at")
  @@index([like_count], name: "idx_like_count")
  @@index([category_id, created_at], name: "idx_category_id_created_at")
  @@map("posts")
}

// 系统设置表
model SystemSetting {
  id            Int      @id @default(autoincrement())
  setting_key   String   @unique @db.VarChar(100)
  setting_value String   @db.Text
  setting_group String   @default("general") @db.VarChar(50)
  description   String?  @db.VarChar(255)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([setting_group], name: "idx_setting_group")
  @@map("system_settings")
}

// 标签表
model Tag {
  id         Int       @id @default(autoincrement())
  name       String    @unique @db.VarChar(50)
  use_count  Int       @default(0)
  created_at DateTime  @default(now())

  posts PostTag[]

  @@index([name], name: "idx_name")
  @@index([use_count], name: "idx_use_count")
  @@map("tags")
}

// 用户作者订阅表
model UserAuthorSubscription {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  author_id  BigInt
  price      Decimal  @db.Decimal(10, 2)
  created_at DateTime @default(now())

  user   User @relation("SubscriptionUser", fields: [user_id], references: [id], onDelete: Cascade)
  author User @relation("SubscriptionAuthor", fields: [author_id], references: [id], onDelete: Cascade)

  @@unique([user_id, author_id], name: "uk_user_author")
  @@index([user_id], name: "idx_user_id")
  @@index([author_id], name: "idx_author_id")
  @@map("user_author_subscriptions")
}

// 石榴点余额表
model UserPoints {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt   @unique
  points     Decimal  @default(0.00) @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], name: "idx_user_id")
  @@map("user_points")
}

// 用户付费内容购买记录表
model UserPurchasedContent {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  post_id       BigInt
  author_id     BigInt
  price         Decimal  @db.Decimal(10, 2)
  purchase_type String   @default("single") @db.VarChar(20)
  created_at    DateTime @default(now())
  purchased_at  DateTime @default(now())

  user   User @relation("PurchasedContentUser", fields: [user_id], references: [id], onDelete: Cascade)
  post   Post @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author User @relation("PurchasedContentAuthor", fields: [author_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id], name: "uk_user_post")
  @@index([user_id], name: "idx_user_id")
  @@index([post_id], name: "idx_post_id")
  @@index([author_id], name: "idx_author_id")
  @@map("user_purchased_content")
}

// 用户会话表
model UserSession {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  token         String   @unique @db.VarChar(255)
  refresh_token String?  @db.VarChar(255)
  expires_at    DateTime @updatedAt
  user_agent    String?  @db.Text
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], name: "idx_user_id")
  @@index([token], name: "idx_token")
  @@index([expires_at], name: "idx_expires_at")
  @@map("user_sessions")
}

// 用户表
model User {
  id             BigInt    @id @default(autoincrement())
  xise_id        String?   @db.VarChar(10)
  password       String?   @db.VarChar(255)
  user_id        String    @unique @db.VarChar(50)
  nickname       String    @db.VarChar(100)
  email          String?   @db.VarChar(100)
  avatar         String?   @db.VarChar(500)
  bio            String?   @db.Text
  location       String?   @db.VarChar(100)
  follow_count   Int       @default(0)
  fans_count     Int       @default(0)
  like_count     Int       @default(0)
  is_active      Boolean   @default(true)
  last_login_at  DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  gender         String?   @db.VarChar(10)
  zodiac_sign    String?   @db.VarChar(20)
  mbti           String?   @db.VarChar(4)
  education      String?   @db.VarChar(50)
  major          String?   @db.VarChar(100)
  interests      Json?
  verified       Boolean   @default(false)
  oauth2_id      BigInt?   @unique

  posts                   Post[]
  comments                Comment[]
  likes                   Like[]
  collections             Collection[]
  followers               Follow[]               @relation("Following")
  following               Follow[]               @relation("Followers")
  notificationsReceived   Notification[]         @relation("NotificationReceiver")
  notificationsSent       Notification[]         @relation("NotificationSender")
  sessions                UserSession[]
  audits                  Audit[]
  points                  UserPoints?
  pointsLogs              PointsLog[]
  subscriptionsAsUser     UserAuthorSubscription[] @relation("SubscriptionUser")
  subscriptionsAsAuthor   UserAuthorSubscription[] @relation("SubscriptionAuthor")
  purchasedContentAsUser  UserPurchasedContent[] @relation("PurchasedContentUser")
  purchasedContentAsAuthor UserPurchasedContent[] @relation("PurchasedContentAuthor")

  @@index([user_id], name: "idx_user_id")
  @@index([email], name: "idx_email")
  @@index([created_at], name: "idx_created_at")
  @@index([oauth2_id], name: "idx_oauth2_id")
  @@map("users")
}
